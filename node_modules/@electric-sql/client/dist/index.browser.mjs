var Ge=Object.defineProperty,Je=Object.defineProperties;var ze=Object.getOwnPropertyDescriptors;var ee=Object.getOwnPropertySymbols;var xe=Object.prototype.hasOwnProperty,Se=Object.prototype.propertyIsEnumerable;var Ce=s=>{throw TypeError(s)};var _e=(s,e,t)=>e in s?Ge(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,R=(s,e)=>{for(var t in e||(e={}))xe.call(e,t)&&_e(s,t,e[t]);if(ee)for(var t of ee(e))Se.call(e,t)&&_e(s,t,e[t]);return s},te=(s,e)=>Je(s,ze(e));var Me=(s,e)=>{var t={};for(var r in s)xe.call(s,r)&&e.indexOf(r)<0&&(t[r]=s[r]);if(s!=null&&ee)for(var r of ee(s))e.indexOf(r)<0&&Se.call(s,r)&&(t[r]=s[r]);return t};var Ee=(s,e,t)=>e.has(s)||Ce("Cannot "+t);var o=(s,e,t)=>(Ee(s,e,"read from private field"),t?t.call(s):e.get(s)),u=(s,e,t)=>e.has(s)?Ce("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t),l=(s,e,t,r)=>(Ee(s,e,"write to private field"),r?r.call(s,t):e.set(s,t),t),m=(s,e,t)=>(Ee(s,e,"access private method"),t);var P=(s,e,t)=>new Promise((r,a)=>{var n=h=>{try{c(t.next(h))}catch(f){a(f)}},i=h=>{try{c(t.throw(h))}catch(f){a(f)}},c=h=>h.done?r(h.value):Promise.resolve(h.value).then(n,i);c((t=t.apply(s,e)).next())});var A=class s extends Error{constructor(t,r,a,n,i,c){super(c||`HTTP Error ${t} at ${i}: ${r!=null?r:JSON.stringify(a)}`);this.url=i;this.name="FetchError",this.status=t,this.text=r,this.json=a,this.headers=n}static fromResponse(t,r){return P(this,null,function*(){let a=t.status,n=Object.fromEntries([...t.headers.entries()]),i,c,h=t.headers.get("content-type");return h&&h.includes("application/json")?c=yield t.json():i=yield t.text(),new s(a,i,c,n,r)})}},B=class extends Error{constructor(){super("Fetch with backoff aborted"),this.name="FetchBackoffAbortError"}};var se=class extends Error{constructor(){super("Invalid shape options: missing required url parameter"),this.name="MissingShapeUrlError"}},re=class extends Error{constructor(){super("Invalid signal option. It must be an instance of AbortSignal."),this.name="InvalidSignalError"}},ne=class extends Error{constructor(){super("shapeHandle is required if this isn't an initial fetch (i.e. offset > -1)"),this.name="MissingShapeHandleError"}},ae=class extends Error{constructor(e){super(`Cannot use reserved Electric parameter names in custom params: ${e.join(", ")}`),this.name="ReservedParamError"}},oe=class extends Error{constructor(e){super(`Column "${e!=null?e:"unknown"}" does not allow NULL values`),this.name="ParserNullValueError"}};var ie=class extends Error{constructor(e,t){let r=`The response for the shape request to ${e} didn't include the following required headers:
`;t.forEach(a=>{r+=`- ${a}
`}),r+=`
This is often due to a proxy not setting CORS correctly so that all Electric headers can be read by the client.`,r+=`
For more information visit the troubleshooting guide: /docs/guides/troubleshooting/missing-headers`,super(r)}};var ce=s=>Number(s),Xe=s=>s==="true"||s==="t",Ze=s=>BigInt(s),ke=s=>JSON.parse(s),et=s=>s,tt={int2:ce,int4:ce,int8:Ze,bool:Xe,float4:ce,float8:ce,json:ke,jsonb:ke};function st(s,e){let t=0,r=null,a="",n=!1,i=0,c;function h(f){let p=[];for(;t<f.length;t++){if(r=f[t],n)r==="\\"?a+=f[++t]:r==='"'?(p.push(e?e(a):a),a="",n=f[t+1]==='"',i=t+2):a+=r;else if(r==='"')n=!0;else if(r==="{")i=++t,p.push(h(f));else if(r==="}"){n=!1,i<t&&p.push(e?e(f.slice(i,t)):f.slice(i,t)),i=t+1;break}else r===","&&c!=="}"&&c!=='"'&&(p.push(e?e(f.slice(i,t)):f.slice(i,t)),i=t+1);c=r}return i<t&&p.push(e?e(f.slice(i,t+1)):f.slice(i,t+1)),p}return h(s)[0]}var le=class{constructor(e){this.parser=R(R({},tt),e)}parse(e,t){return JSON.parse(e,(r,a)=>{if(r==="value"&&typeof a=="object"&&a!==null){let n=a;Object.keys(n).forEach(i=>{n[i]=this.parseRow(i,n[i],t)})}return a})}parseRow(e,t,r){var C;let a=r[e];if(!a)return t;let p=a,{type:n,dims:i}=p,c=Me(p,["type","dims"]),h=(C=this.parser[n])!=null?C:et,f=Ue(h,a,e);return i&&i>0?Ue((E,L)=>st(E,f),a,e)(t):f(t,c)}};function Ue(s,e,t){var a;let r=!((a=e.not_null)!=null&&a);return n=>{if(rt(n)){if(!r)throw new oe(t!=null?t:"unknown");return null}return s(n,e)}}function rt(s){return s===null||s==="NULL"}function he(s){return"key"in s}function fe(s){return!he(s)}function He(s){return fe(s)&&s.headers.control==="up-to-date"}var ve="electric-cursor",K="electric-handle",ue="electric-offset",Oe="electric-schema",De="electric-up-to-date",Le="columns",ge="cursor",W="handle",M="live",$="offset",Ie="table",Fe="where",Ne="replica";var nt=[429],de={initialDelay:100,maxDelay:1e4,multiplier:1.3};function Be(s,e=de){let{initialDelay:t,maxDelay:r,multiplier:a,debug:n=!1,onFailedAttempt:i}=e;return(...c)=>P(this,null,function*(){var V;let h=c[0],f=c[1],p=t,C=0;for(;;)try{let E=yield s(...c);if(E.ok)return E;throw yield A.fromResponse(E,h.toString())}catch(E){if(i==null||i(),(V=f==null?void 0:f.signal)!=null&&V.aborted)throw new B;if(E instanceof A&&!nt.includes(E.status)&&E.status>=400&&E.status<500)throw E;yield new Promise(L=>setTimeout(L,p)),p=Math.min(p*a,r),n&&(C++,console.log(`Retry attempt #${C} after ${p}ms`))}})}var at={maxChunksToPrefetch:2};function Ye(s,e=at){let{maxChunksToPrefetch:t}=e,r;return(...n)=>P(this,null,function*(){let i=n[0].toString(),c=r==null?void 0:r.consume(...n);if(c)return c;r==null||r.abort();let h=yield s(...n),f=be(i,h);return f&&(r=new Re({fetchClient:s,maxPrefetchedRequests:t,url:f,requestInit:n[1]})),h})}var ot=["electric-offset","electric-handle"],it=["electric-cursor"],ct=["electric-schema"];function je(s){return(...e)=>P(this,null,function*(){let t=yield s(...e);if(t.ok){let r=t.headers,a=[],n=f=>a.push(...f.filter(p=>!r.has(p)));n(ot);let c=e[0].toString(),h=new URL(c);if(h.searchParams.get(M)==="true"&&n(it),(!h.searchParams.has(M)||h.searchParams.get(M)==="false")&&n(ct),a.length>0)throw new ie(c,a)}return t})}var G,J,y,I,T,Y,pe,Re=class{constructor(e){u(this,Y);u(this,G);u(this,J);u(this,y,new Map);u(this,I);u(this,T);var t;l(this,G,(t=e.fetchClient)!=null?t:(...r)=>fetch(...r)),l(this,J,e.maxPrefetchedRequests),l(this,I,e.url.toString()),l(this,T,o(this,I)),m(this,Y,pe).call(this,e.url,e.requestInit)}abort(){o(this,y).forEach(([e,t])=>t.abort())}consume(...e){var a;let t=e[0].toString(),r=(a=o(this,y).get(t))==null?void 0:a[0];if(!(!r||t!==o(this,I)))return o(this,y).delete(t),r.then(n=>{let i=be(t,n);l(this,I,i),o(this,T)&&!o(this,y).has(o(this,T))&&m(this,Y,pe).call(this,o(this,T),e[1])}).catch(()=>{}),r}};G=new WeakMap,J=new WeakMap,y=new WeakMap,I=new WeakMap,T=new WeakMap,Y=new WeakSet,pe=function(...e){var a,n;let t=e[0].toString();if(o(this,y).size>=o(this,J))return;let r=new AbortController;try{let i=o(this,G).call(this,t,te(R({},(a=e[1])!=null?a:{}),{signal:lt(r,(n=e[1])==null?void 0:n.signal)}));o(this,y).set(t,[i,r]),i.then(c=>{if(!c.ok||r.signal.aborted)return;let h=be(t,c);if(!h||h===t){l(this,T,void 0);return}return l(this,T,h),m(this,Y,pe).call(this,h,e[1])}).catch(()=>{})}catch(i){}};function be(s,e){let t=e.headers.get(K),r=e.headers.get(ue),a=e.headers.has(De);if(!t||!r||a)return;let n=new URL(s);if(!n.searchParams.has(M))return n.searchParams.set(W,t),n.searchParams.set($,r),n.searchParams.sort(),n.toString()}function lt(s,e){return e&&(e.aborted?s.abort():e.addEventListener("abort",()=>s.abort(),{once:!0})),s.signal}var Qe=new Set([ge,W,M,$]);function ht(s){let e={};for(let[t,r]of Object.entries(s))e[t]=Array.isArray(r)?r.join(","):r;return e}var z,X,Z,k,U,F,H,w,v,_,N,j,g,Ae,ye,Ve,Te,Pe=class{constructor(e){u(this,g);u(this,z,null);u(this,X);u(this,Z);u(this,k,new Map);u(this,U);u(this,F);u(this,H);u(this,w,!1);u(this,v,!1);u(this,_);u(this,N);u(this,j);var a,n,i;this.options=R({subscribe:!0},e),ft(this.options),l(this,U,(a=this.options.offset)!=null?a:"-1"),l(this,F,""),l(this,_,this.options.handle),l(this,Z,new le(e.parser)),l(this,j,this.options.onError);let t=(n=e.fetchClient)!=null?n:(...c)=>fetch(...c),r=Be(t,te(R({},(i=e.backoffOptions)!=null?i:de),{onFailedAttempt:()=>{var c,h;l(this,v,!1),(h=(c=e.backoffOptions)==null?void 0:c.onFailedAttempt)==null||h.call(c)}}));l(this,X,je(Ye(r))),m(this,g,Ae).call(this)}get shapeHandle(){return o(this,_)}get error(){return o(this,z)}get isUpToDate(){return o(this,w)}get lastOffset(){return o(this,U)}subscribe(e,t=()=>{}){let r=Math.random();return o(this,k).set(r,[e,t]),()=>{o(this,k).delete(r)}}unsubscribeAll(){o(this,k).clear()}lastSyncedAt(){return o(this,H)}lastSynced(){return o(this,H)===void 0?1/0:Date.now()-o(this,H)}isConnected(){return o(this,v)}isLoading(){return!o(this,w)}};z=new WeakMap,X=new WeakMap,Z=new WeakMap,k=new WeakMap,U=new WeakMap,F=new WeakMap,H=new WeakMap,w=new WeakMap,v=new WeakMap,_=new WeakMap,N=new WeakMap,j=new WeakMap,g=new WeakSet,Ae=function(){return P(this,null,function*(){var e,t;try{for(;!((e=this.options.signal)!=null&&e.aborted)&&!o(this,w)||this.options.subscribe;){let{url:r,signal:a}=this.options,n=new URL(r);if(this.options.params){let d=Object.keys(this.options.params).filter(me=>Qe.has(me));if(d.length>0)throw new Error(`Cannot use reserved Electric parameter names in custom params: ${d.join(", ")}`);let b=ht(this.options.params);b.table&&n.searchParams.set(Ie,b.table),b.where&&n.searchParams.set(Fe,b.where),b.columns&&n.searchParams.set(Le,b.columns),b.replica&&n.searchParams.set(Ne,b.replica);let q=R({},b);delete q.table,delete q.where,delete q.columns,delete q.replica;for(let[me,$e]of Object.entries(q))n.searchParams.set(me,$e)}n.searchParams.set($,o(this,U)),o(this,w)&&(n.searchParams.set(M,"true"),n.searchParams.set(ge,o(this,F))),o(this,_)&&n.searchParams.set(W,o(this,_)),n.searchParams.sort();let i;try{i=yield o(this,X).call(this,n.toString(),{signal:a,headers:this.options.headers}),l(this,v,!0)}catch(d){if(d instanceof B)break;if(!(d instanceof A))throw d;if(d.status==409){let b=d.headers[K];m(this,g,Te).call(this,b),yield m(this,g,ye).call(this,d.json);continue}else if(d.status>=400&&d.status<500)throw m(this,g,Ve).call(this,d),d}let{headers:c,status:h}=i,f=c.get(K);f&&l(this,_,f);let p=c.get(ue);p&&l(this,U,p);let C=c.get(ve);C&&l(this,F,C);let V=()=>{let d=c.get(Oe);return d?JSON.parse(d):{}};l(this,N,(t=o(this,N))!=null?t:V());let E=h===204?"[]":yield i.text();h===204&&l(this,H,Date.now());let L=o(this,Z).parse(E,o(this,N));if(L.length>0){let d=L[L.length-1];He(d)&&(l(this,H,Date.now()),l(this,w,!0)),yield m(this,g,ye).call(this,L)}}}catch(r){if(l(this,z,r),o(this,j)){let a=yield o(this,j).call(this,r);typeof a=="object"&&(m(this,g,Te).call(this),"params"in a&&(this.options.params=a.params),"headers"in a&&(this.options.headers=a.headers),m(this,g,Ae).call(this));return}throw r}finally{l(this,v,!1)}})},ye=function(e){return P(this,null,function*(){yield Promise.all(Array.from(o(this,k).values()).map(a=>P(this,[a],function*([t,r]){try{yield t(e)}catch(n){queueMicrotask(()=>{throw n})}})))})},Ve=function(e){o(this,k).forEach(([t,r])=>{r==null||r(e)})},Te=function(e){l(this,U,"-1"),l(this,F,""),l(this,_,e),l(this,w,!1),l(this,v,!1),l(this,N,void 0)},Pe.Replica={FULL:"full",DEFAULT:"default"};function ft(s){if(!s.url)throw new se;if(s.signal&&!(s.signal instanceof AbortSignal))throw new re;if(s.offset!==void 0&&s.offset!=="-1"&&!s.handle)throw new ne;if(s.params){let e=Object.keys(s.params).filter(t=>Qe.has(t));if(e.length>0)throw new ae(e)}}var x,O,Q,D,S,Ke,We,we,qe=class{constructor(e){u(this,S);u(this,x,new Map);u(this,O,new Map);u(this,Q,!1);u(this,D,!1);this.stream=e,this.stream.subscribe(m(this,S,Ke).bind(this),m(this,S,We).bind(this))}get isUpToDate(){return this.stream.isUpToDate}get lastOffset(){return this.stream.lastOffset}get handle(){return this.stream.shapeHandle}get rows(){return this.value.then(e=>Array.from(e.values()))}get currentRows(){return Array.from(this.currentValue.values())}get value(){return new Promise((e,t)=>{if(this.stream.isUpToDate)e(this.currentValue);else{let r=this.subscribe(({value:a})=>{r(),o(this,D)&&t(o(this,D)),e(a)})}})}get currentValue(){return o(this,x)}get error(){return o(this,D)}lastSyncedAt(){return this.stream.lastSyncedAt()}lastSynced(){return this.stream.lastSynced()}isLoading(){return this.stream.isLoading()}isConnected(){return this.stream.isConnected()}subscribe(e){let t=Math.random();return o(this,O).set(t,e),()=>{o(this,O).delete(t)}}unsubscribeAll(){o(this,O).clear()}get numSubscribers(){return o(this,O).size}};x=new WeakMap,O=new WeakMap,Q=new WeakMap,D=new WeakMap,S=new WeakSet,Ke=function(e){let t=!1,r=!1,a=!1;e.forEach(n=>{if(he(n))switch(t=["insert","update","delete"].includes(n.headers.operation),n.headers.operation){case"insert":o(this,x).set(n.key,n.value);break;case"update":o(this,x).set(n.key,R(R({},o(this,x).get(n.key)),n.value));break;case"delete":o(this,x).delete(n.key);break}if(fe(n))switch(n.headers.control){case"up-to-date":r=!0,o(this,Q)||(a=!0);break;case"must-refetch":o(this,x).clear(),l(this,D,!1),l(this,Q,!1),r=!1,a=!1;break}}),(a||r&&t)&&(l(this,Q,!0),m(this,S,we).call(this))},We=function(e){e instanceof A&&(l(this,D,e),m(this,S,we).call(this))},we=function(){o(this,O).forEach(e=>{e({value:this.currentValue,rows:this.currentRows})})};export{de as BackoffDefaults,A as FetchError,qe as Shape,Pe as ShapeStream,he as isChangeMessage,fe as isControlMessage};
//# sourceMappingURL=index.browser.mjs.map